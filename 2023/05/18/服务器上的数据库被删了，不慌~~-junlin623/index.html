<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;junlin623&#x2F;p&#x2F;17169437.html  title: ‘服务器上的数据库被删了，不慌~~-junlin623’date: 2023-03-01 19:36:00      一、发现问题： 近期访问我的网站的时候登录报错，到主机上查看了一下日志才发现系统找不到指定数据库， 慌张的我赶紧连接了一下数据库看看，发现真的是数据库被黑了  tex">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2023/05/18/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A2%AB%E5%88%A0%E4%BA%86%EF%BC%8C%E4%B8%8D%E6%85%8C~~-junlin623/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;junlin623&#x2F;p&#x2F;17169437.html  title: ‘服务器上的数据库被删了，不慌~~-junlin623’date: 2023-03-01 19:36:00      一、发现问题： 近期访问我的网站的时候登录报错，到主机上查看了一下日志才发现系统找不到指定数据库， 慌张的我赶紧连接了一下数据库看看，发现真的是数据库被黑了  tex">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193449390-1236733938.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193001481-815700271.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193101470-868666572.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193136686-2036280328.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193204749-2000109161.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193213377-483221132.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193247965-650639712.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193253829-491050307.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193302084-214583454.png">
<meta property="og:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193320194-1666106440.png">
<meta property="article:published_time" content="2023-05-17T16:09:35.164Z">
<meta property="article:modified_time" content="2023-05-17T11:57:00.814Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193449390-1236733938.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-服务器上的数据库被删了，不慌~~-junlin623" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/05/18/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A2%AB%E5%88%A0%E4%BA%86%EF%BC%8C%E4%B8%8D%E6%85%8C~~-junlin623/" class="article-date">
  <time class="dt-published" datetime="2023-05-17T16:09:35.164Z" itemprop="datePublished">2023-05-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/junlin623/p/17169437.html">https://www.cnblogs.com/junlin623/p/17169437.html</a></p>
<hr>
<p>title: ‘服务器上的数据库被删了，不慌~~-junlin623’<br>date: 2023-03-01 19:36:00</p>
<hr>
<meta name = "referrer" content = "no-referrer" />



<h3 id="一、发现问题："><a href="#一、发现问题：" class="headerlink" title="一、发现问题："></a>一、发现问题：</h3><hr>
<p>近期访问我的网站的时候登录报错，到主机上查看了一下日志才发现系统找不到指定数据库，</p>
<p>慌张的我赶紧连接了一下数据库看看，发现真的是数据库被黑了</p>
<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193449390-1236733938.png"></p>
<p>text	<br>All your data was backed up from your server. You need to email us at <a href="mailto:&#114;&#97;&#x73;&#x6d;&#117;&#x73;&#x2b;&#50;&#54;&#54;&#57;&#x65;&#64;&#x6f;&#x6e;&#x69;&#x6f;&#x6e;&#109;&#x61;&#x69;&#x6c;&#46;&#x6f;&#114;&#103;">&#114;&#97;&#x73;&#x6d;&#117;&#x73;&#x2b;&#50;&#54;&#54;&#57;&#x65;&#64;&#x6f;&#x6e;&#x69;&#x6f;&#x6e;&#109;&#x61;&#x69;&#x6c;&#46;&#x6f;&#114;&#103;</a> to recover your data. If you dont contact us we will reach the General Data Protection Regulation, GDPR, and notify them that you store user data in an open form that is not safe. Under the rules of the law, you face a heavy fine or arrest and your database dump will be deleted from our server forever!</p>
<p>翻译了一下：</p>
<p>​	您的所有数据都从您的服务器备份。您需要发送电子邮件给我们 <a href="mailto:&#114;&#x61;&#115;&#x6d;&#117;&#115;&#43;&#50;&#54;&#54;&#57;&#101;&#x40;&#111;&#x6e;&#x69;&#x6f;&#110;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#111;&#114;&#x67;">&#114;&#x61;&#115;&#x6d;&#117;&#115;&#43;&#50;&#54;&#54;&#57;&#101;&#x40;&#111;&#x6e;&#x69;&#x6f;&#110;&#x6d;&#x61;&#105;&#x6c;&#x2e;&#111;&#114;&#x67;</a> 以恢复您的数据。如果您不联系我们，我们将联系通用数据保护条例 GDPR，并通知他们您以不安全的开放形式存储用户数据。根据法律规定，您将面临巨额罚款或逮捕，您的数据库转储将从我们的服务器中永久删除！</p>
<p>wc，好害怕！！！</p>
<h3 id="二、分析一波："><a href="#二、分析一波：" class="headerlink" title="二、分析一波："></a>二、分析一波：</h3><p>​	原因可能就是黑客扫描到公网的主机，发现开放了3306端口，并通过破解密码进入，进行一系列操作，然后跑路</p>
<p>我们可以通过查看Mysql中的binlog日志看看它到底干了些什么：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 登录到mysql，执行以下命令，后面代表的是要查看的日志的文件名</span><br><span class="line">show binlog events in &quot;binlog.000005&quot;;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193001481-815700271.png"></p>
<pre><code>* 删除了数据库
* 创建了一个新的数据库 README_TO_RECOVER_A
* 在这个数据库里建了张表 RECOVER_YOUR_DATA
* 插入了一条数据，“提醒我们”
* 删除root用户对于所有数据库的权限
</code></pre>
<p>也可在终端中查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog <span class="string">&quot;binlog.000005&quot;</span>  <span class="comment"># 能够查看更详细的信息，比如时间等</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193101470-868666572.png"></p>
<p>在此还是提醒大家的数据库不要设置成太简单的密码，root（比如我hh），123等等，很容易被暴力破解</p>
<h3 id="三、数据库恢复："><a href="#三、数据库恢复：" class="headerlink" title="三、数据库恢复："></a>三、数据库恢复：</h3><p>既然已经发生了，就要想办法恢复数据库</p>
<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193136686-2036280328.png"></p>
<p>通过查看binlog日志发现，删库的日期是在26号，所以直接恢复该日期之前的sql操作即可</p>
<p>由于我的删库操作记录在 binlog.000005 中，所以我们需要恢复binlog.000001~4以及 binlog.000005中的26号之前的sql操作</p>
<p>写一个python脚本生成恢复的sql文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">os.chdir(<span class="string">&quot;/var/lib/mysql&quot;</span>)</span><br><span class="line">files = os.listdir(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">	<span class="keyword">if</span> file.startswith(<span class="string">&quot;binlog.0&quot;</span>):</span><br><span class="line">		num = <span class="built_in">int</span>(file[<span class="built_in">len</span>(file)-<span class="number">1</span>])</span><br><span class="line">		<span class="keyword">if</span> num &gt; <span class="number">5</span>:</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		<span class="keyword">elif</span> num == <span class="number">5</span>:</span><br><span class="line">			os.system(<span class="string">&quot;mysqlbinlog --no-defaults -v --base64-output=decode-rows &#123;&#125;  --stop-datetime=&#x27;2023-02-26 00:00:00&#x27; &gt;&gt; /home/recover.sql&quot;</span>.<span class="built_in">format</span>(file))</span><br><span class="line">		<span class="keyword">else</span>: </span><br><span class="line">			os.system(<span class="string">&quot;mysqlbinlog --no-defaults -v --base64-output=decode-rows &#123;&#125; &gt;&gt; /home/recover.sql&quot;</span>.<span class="built_in">format</span>(file))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>执行完该脚本之后会在 &#x2F;home目录下生成 recover.sql 文件</p>
<p>登录到mysql中，根据该sql文件恢复数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /home/recover.sql</span><br></pre></td></tr></table></figure>

<p>运行过程中会出现以下错误：</p>
<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193204749-2000109161.png"></p>
<p>原因就是入侵者将root用户的权限全部收回了</p>
<p>去赋予root用户权限也没用：</p>
<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193213377-483221132.png"></p>
<p><strong>解决方案：</strong></p>
<p>查看root用户是否有所有的权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM mysql.user WHERE USER=&quot;root&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193247965-650639712.png"></p>
<p>可以发现有一些是 No， 所以我们要全部改成 Y，不用全改也可以，但是 Grant 权限必须是 Yes：</p>
<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193253829-491050307.png"></p>
<p>执行下面的命令来恢复root用户权限：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br></pre></td></tr></table></figure>

<p>再次执行恢复数据库：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /home/recover.sql</span><br></pre></td></tr></table></figure>



<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193302084-214583454.png"></p>
<p>成功恢复~~</p>
<h3 id="四、问题规避："><a href="#四、问题规避：" class="headerlink" title="四、问题规避："></a>四、问题规避：</h3><ol>
<li><p>避免mysql的root用户密码太简单：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 用root用户登录到mysql后执行</span><br><span class="line">set password=&quot;xxx&quot;;  -- xxx表示root用户密码</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以考虑更换一下mysql的服务端口，（但是好像也没什么用hh，因为可以通过扫描得出监听该端口的应用程序，即使不是3306端口，监听的应用程序是mysql也可以判断是数据库服务）</p>
</li>
<li><p>尽量不要让root用户host是 % ,改成特定ip地址, （但网站还是要让所有人访问的，也是没办法）</p>
</li>
<li><p>尽量不要使用root用户连接数据库， 有的应用程序会将root用户的密码在配置文件中体现，不利于安全性：</p>
</li>
</ol>
<p><img src="https://img2023.cnblogs.com/blog/2935791/202303/2935791-20230301193320194-1666106440.png"></p>
   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 创建一个新用户</span><br><span class="line">create user &quot;client&quot;@&#x27;%&#x27; identified by &quot;xxx&quot;;</span><br></pre></td></tr></table></figure>

   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 给这个用户赋予项目数据库的所有权限</span><br><span class="line">grant all privileges on homesystem.* to client;</span><br></pre></td></tr></table></figure>

<p>   在项目中让client这个用户去连接数据库，这样就能避免root用户密码暴露的问题</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/05/18/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A2%AB%E5%88%A0%E4%BA%86%EF%BC%8C%E4%B8%8D%E6%85%8C~~-junlin623/" data-id="clhrwf8jl001zeksz3kkafgme" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2023/05/18/%E6%9B%B4%E6%94%B9Maven%E6%9C%AC%E5%9C%B0%E4%BB%93%E5%BA%93%E7%9A%84%E4%BD%8D%E7%BD%AE-junlin623/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2023/05/18/%E5%8F%91%E7%8E%B0%E5%B1%80%E5%9F%9F%E7%BD%91%E4%B8%AD%E5%AD%98%E6%B4%BB%E4%B8%BB%E6%9C%BA-junlin623/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/05/">May 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/05/18/%E7%9B%B4%E8%BF%9E%E8%B7%AF%E7%94%B1%E8%A1%A8%E9%A1%B9%E8%A7%A3%E6%9E%90-junlin623/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/05/18/%E6%95%B4%E6%95%B0%E5%88%92%E5%88%86%E9%97%AE%E9%A2%98-junlin623/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/05/18/%E5%8E%9F%E7%94%9F%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2JavaWeb%E9%A1%B9%E7%9B%AE%E5%88%B0%E8%BF%9C%E7%A8%8B%E4%B8%BB%E6%9C%BA-junlin623/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/05/18/%E5%8E%9F%E6%9D%A5%E6%98%AFvmware-hostd%E7%A8%8B%E5%BA%8F%E5%8D%A0%E7%94%A8%E4%BA%86443%E7%AB%AF%E5%8F%A3-junlin623/">(no title)</a>
          </li>
        
          <li>
            <a href="/2023/05/18/%E5%AD%A6%E7%94%9F%E5%8F%AF%E4%BB%A5%E7%99%BD%E5%AB%96%E9%98%BF%E9%87%8C%E4%BA%91ECS%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%8D%8A%E5%B9%B4~~-junlin623/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>